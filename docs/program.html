<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>Theory - RocIBCFD</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>

    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ]
        });"></script>
    <style>
                .flowchart-wrapper {
                    display: flex;
                    justify-content: center; /* This centers your flowchart */
                }
                .flowchart-wrapper .mermaid {
                    min-width: 600px;  /* Adjust this value as needed */
                    max-width: 100%; /* Allows it to be responsive */
                }
                /* Make Mermaid-rendered SVGs fill the mermaid container */
                .mermaid svg {
                    width: 100% !important;
                    height: 100% !important;
                    max-width: none !important;
                    display: block;
                    margin-left: auto;
                    margin-right: auto;
                }

                /* Trial dimensions: adjust these values (height / max-width) as needed */
                .mermaid {
                    width: 100%;            /* use most of the page width */
                    max-width: 1800px;    /* cap width to avoid overly wide diagrams */
                    height: 50vh;         /* try 60vh, 70vh, 80vh or px values like 700px */
                    margin: 0 auto 2rem auto;
                    overflow: visible;    /* allow svg to be visible if larger */
                }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600&display=swap" rel="stylesheet">
    
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header Navigation -->
    <header class="shadow-md sticky top-0 z-40">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <!-- Project Title -->
            <a href="index.html" class="text-2xl font-bold text-white">RocIBCFD</a>

            <!-- Mobile Menu Button -->
            <button id="mobile-menu-button" class="md:hidden text-gray-700 focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                </svg>
            </button>

            <!-- Desktop Navigation Links -->
            <div class="hidden md:flex items-center space-x-6">
                <div class="relative group">
                    <a href="index.html" class="text-white transition-colors font-bold">
                        Home
                        <svg class="w-4 h-4 inline-block ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </a>
                    
                    <div class="absolute -left-4 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden group-hover:block">
                        <a href="index.html#about" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">About RocIBCFD</a>
                        <a href="index.html#install" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Quick Installation</a>
                        <a href="index.html#publications" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Publications</a>
                        <a href="index.html#contact" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Contact</a>
                    </div>
                </div>
            
                <div class="relative group">
                    <a href="equations.html" class="text-white transition-colors font-bold">
                        Theory
                        <svg class="w-4 h-4 inline-block ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </a>
                    <div class="absolute -left-4 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden group-hover:block">
                        <a href="equations.html#governing-equations" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Equations</a>
                        <a href="equations.html#closure-models" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Closure Models</a>
                        <a href="equations.html#solution-algo" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Solution Algorithm</a>
                    </div>
                </div>
            
                <div class="relative group">
                    <button class="text-white bg-blue-600 px-3 py-2 rounded-md text-sm font-bold" aria-current="page">
                        Program
                        <svg class="w-4 h-4 inline-block ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="absolute -left-4 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden group-hover:block">
                        <a href="#repository-structure" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Repo-structure</a>
                        <a href="#solver" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">CFD Solver</a>
                        <a href="#library" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Libraries</a>
                        <a href="#utilities" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Utilities</a>
                    </div>
                </div>
                
                <div class="relative group">
                    <a href="tutorials.html" class="text-white transition-colors font-bold">
                        Tutorials
                        <svg class="w-4 h-4 inline-block ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </a>
                    <div class="absolute -left-4 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden group-hover:block">
                        <a href="tutorials.html#gas-nozzle" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">CD Nozzle - Gas</a>
                        <a href="tutorials.html#two-phase-nozzle" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Two phase CD Nozzle</a>
                        <a href="tutorials.html#steady-SRM" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Steady SRM</a>
                        <a href="tutorials.html#regression-SRM" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Transient SRM</a>
                    </div>
                </div>
                <a href="html/index.html" class="text-white hover:text-red-500 transition-colors" target="_blank">API Documentation</a>
            </div>
        </nav>

        <!-- Mobile Menu (Hidden by default) -->
        <div id="mobile-menu" class="hidden md:hidden px-2 pt-2 pb-3 space-y-1">
            <a href="index.html" class="block px-3 py-2 rounded-md text-base font-bold text-white hover:bg-blue-700">Home</a>
            <a href="equations.html" class="block px-3 py-2 rounded-md text-base font-bold text-white bg-blue-600" aria-current="page">Theory</a>
            <a href="program.html" class="block px-3 py-2 rounded-md text-base font-bold text-white hover:bg-blue-700">Program</a>
            <a href="tutorials.html" class="block px-3 py-2 rounded-md text-base font-bold text-white hover:bg-blue-700">Tutorials</a>
            <a href="html/index.html" class="block px-3 py-2 rounded-md text-base font-bold text-white hover:bg-blue-700" target="_blank">API Documentation</a>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <section id="repository-structure" class="bg-white">
            <div class="container mx-auto px-6">
                <div class="max-w-7xl mx-auto">
                    <p class="text-2xl font-bold text-gray-900 mb-4">Libraries and Solver</p>
                    <p class="text-lg text-gray-700 leading-relaxed mb-4">The main application is <strong>rocketMotor</strong>
                        which depends on several libraries including the base libraries of OpenFOAM-v2112. The solver is developed
                        based on the native OpenFOAM v2112 solver "reactingMultiphaseEulerFoam". This framework has an additional
                        library that includes the relavant closure models for propellant surface regression and interphase 
                        interactions (drag and heat transfer models). 
                    </p>
                </div>
            </div>
            <div class="mermaid">
                %%{ init: { 
                    'theme': 'neutral', 
                    'fontFamily': 'Exo 2', 
                    'flowchart': { 'curve': 'stepAfter' }, 
                    'themeVariables': { 
                      'primaryColor': '#ffffff',
                      'edgeLabelBackground': '#ffffff', 
                      'tertiaryColor': '#ffffff', 
                      'lineColor': '#000000'
                    } 
                  } }%%
                flowchart LR
                subgraph OpenFOAM_Base_Group [<strong>OpenFOAM v2112 Base Libraries</strong>]
                    List["libfiniteVolume.so <br/> libOpenFOAM.so <br/> libfluidThermophysicalModels.so <br/> libreactionThermophysicalModels.so <br/> libcompressibleTransportModels.so <br/> libspecie.so <br/> libcompressibleTurbulenceModels.so <br/> libturbulenceModels.so <br/> libthermophysicalProperties.so <br/> libcombustionModels.so <br/> libmeshTools.so <br/> libsurfMesh.so <br/> libdynamicMesh.so"]
                    style List text-align:left
                end

                subgraph OpenFOAM_Multiphase_Group [<strong>OpenFOAM v2112 Multiphase Library</strong>]
                    B["libreactingMultiphaseSystem.so"]
                end
                C["<strong>RocIBCFD Framework source</strong> <br/> (libpropellantRegressionPhaseSystem.so)"]
                D["<div style='padding: 30px 50px'><span style='font-size:30px; font-weight:bold'>rocketMotor</span> <br/> (Main Application)</div>"]

                List -->|Mesh, Thermophysical and <br/> Transport properties| C
                B -->|Phase Models, Phase System <br/> and Phase Pair| C
                C -->|Multiphase Systems <br/> Interphase Models| D

                %% Subgraphs (Outer Boxes)
                style OpenFOAM_Base_Group fill:#fff8e1,stroke:#ffa000,stroke-width:2px;
                style OpenFOAM_Multiphase_Group fill:#fff8e1,stroke:#ffa000,stroke-width:2px;
                        
                %% Nodes (Inner Boxes)
                style List fill:#ffe0b2,stroke:#ffa000,stroke-width:1px;
                style B fill:#ffe0b2,stroke:#ffa000,stroke-width:1px;
                style C fill:#eceff1,stroke:#78909c,stroke-width:2px;
                style D fill:#c5e1a5,stroke:#7cb342,stroke-width:4px;
                        
                %% Link Styling 
                linkStyle 0,1,2 stroke:#000000,stroke-width:2px,fill:none,color:#000000
            </div>
        </section>
        <section class="cn-wrapper">
            <div class="cn-container">
                
                <div class="cn-sticky-col">
                    <div class="cn-code-window">
                        <div class="cn-window-header">
                            <span class="cn-dot red"></span>
                            <span class="cn-dot yellow"></span>
                            <span class="cn-dot green"></span>
                            <span class="cn-filename">rocketMotor/main.C</span>
                        </div>
                        <pre>
        <span class="cn-line" id="L1"><span class="kwd">#include</span> "fvCFD.H"</span>
        <span class="cn-line" id="L2"><span class="kwd">#include</span> "multiPhaseSystem.H"</span>
        <span class="cn-line" id="L3"><span class="kwd">#include</span> "pimpleControl.H"</span>
        <span class="cn-line" id="L4"><span class="com">// ... standard OpenFOAM includes ...</span></span>
        <span class="cn-line" id="L5"></span>
        <span class="cn-line" id="L6"><span class="kwd">int</span> <span class="fun">main</span>(<span class="kwd">int</span> argc, <span class="kwd">char</span> *argv[])</span>
        <span class="cn-line" id="L7">{</span>
        <span class="cn-line" id="L8">    <span class="kwd">#include</span> "postProcess.H"</span>
        <span class="cn-line" id="L9">    <span class="kwd">#include</span> "setRootCase.H"</span>
        <span class="cn-line" id="L10">    <span class="kwd">#include</span> "createTime.H"</span>
        <span class="cn-line" id="L11">    <span class="kwd">#include</span> "createMesh.H"</span>
        <span class="cn-line" id="L12">    <span class="kwd">#include</span> "createFields.H"</span>
        <span class="cn-line" id="L13"></span>
        <span class="cn-line" id="L14">    <span class="com">// Correcting Phase Volume Fractions</span></span>
        <span class="cn-line" id="L15">    <span class="kwd">forAll</span>(fluid.phases(), phasei) {</span>
        <span class="cn-line" id="L16">        fluid.phases()[phasei].<span class="fun">clip</span>(SMALL, 1 - SMALL);</span>
        <span class="cn-line" id="L17">    }</span>
        <span class="cn-line" id="L18"></span>
        <span class="cn-line" id="L19">    <span class="typ">label</span> propellantIndex = fluid.<span class="fun">get</span>&lt;<span class="typ">label</span>&gt;(<span class="str">"propellantIndex"</span>);</span>
        <span class="cn-line" id="L20"></span>
        <span class="cn-line" id="L21">    <span class="kwd">while</span> (runTime.<span class="fun">run</span>())</span>
        <span class="cn-line" id="L22">    {</span>
        <span class="cn-line" id="L23">        <span class="kwd">#include</span> "readTimeControls.H"</span>
        <span class="cn-line" id="L24">        <span class="kwd">#include</span> "CourantNo.H"</span>
        <span class="cn-line" id="L25"></span>
        <span class="cn-line" id="L26">        runTime++;</span>
        <span class="cn-line" id="L27">        Info&lt;&lt; <span class="str">"Time = "</span> &lt;&lt; runTime.<span class="fun">timeName</span>() &lt;&lt; nl &lt;&lt; endl;</span>
        <span class="cn-line" id="L28"></span>
        <span class="cn-line" id="L29">        <span class="com">// --- Pressure-velocity PIMPLE corrector loop</span></span>
        <span class="cn-line" id="L30">        <span class="kwd">while</span> (pimple.<span class="fun">loop</span>())</span>
        <span class="cn-line" id="L31">        {</span>
        <span class="cn-line" id="L32">            fluid.<span class="fun">solve</span>();</span>
        <span class="cn-line" id="L33">            fluid.<span class="fun">correct</span>();</span>
        <span class="cn-line" id="L34"></span>
        <span class="cn-line" id="L35">            <span class="com">// Solve Conservation Equations</span></span>
        <span class="cn-line" id="L36">            <span class="kwd">#include</span> "pU/UEqns.H"</span>
        <span class="cn-line" id="L37">            <span class="kwd">#include</span> "EEqns.H"</span>
        <span class="cn-line" id="L38">            <span class="kwd">#include</span> "pU/pEqn.H"</span>
        <span class="cn-line" id="L39">        }</span>
        <span class="cn-line" id="L40"></span>
        <span class="cn-line" id="L41">        <span class="kwd">if</span> (runTime.<span class="fun">writeTime</span>())</span>
        <span class="cn-line" id="L42">        {</span>
        <span class="cn-line" id="L43">            <span class="com">// Calculate Mach Number</span></span>
        <span class="cn-line" id="L44">            Mach = <span class="fun">mag</span>(phases[0].<span class="fun">U</span>())/<span class="fun">sqrt</span>(Gammag*p/Rhog);</span>
        <span class="cn-line" id="L45">        }</span>
        <span class="cn-line" id="L46"></span>
        <span class="cn-line" id="L47">        runTime.<span class="fun">write</span>();</span>
        <span class="cn-line" id="L48">    }</span>
        <span class="cn-line" id="L49">    </span>
        <span class="cn-line" id="L50">    ::_Exit(0);</span>
        <span class="cn-line" id="L51">}</span>
                        </pre>
                    </div>
                </div>
        
                <div class="cn-scroll-col">
                    
                    <div class="cn-step" data-lines="L1,L2,L3">
                        <h3>OpenFOAM Libraries</h3>
                        <p>We import the core Finite Volume (fvCFD) and Multiphase frameworks. This provides the mathematical foundation for solving Navier-Stokes equations across multiple fluid states (liquid propellant and gas).</p>
                    </div>
        
                    <div class="cn-step" data-lines="L8,L9,L10,L11,L12">
                        <h3>Case Initialization</h3>
                        <p>Standard OpenFOAM boilerplate. This initializes the <code>Time</code> object, generates the 3D <code>Mesh</code>, and allocates memory for the fields (Pressure, Velocity, Temperature) defined in the case files.</p>
                    </div>
        
                    <div class="cn-step" data-lines="L15,L16,L19">
                        <h3>Phase Safety Checks</h3>
                        <p>Before the simulation starts, we clip the volume fractions between <code>SMALL</code> and <code>1-SMALL</code> to prevent numerical instability. We also identify the specific <code>propellantIndex</code> to track the fuel phase.</p>
                    </div>
        
                    <div class="cn-step" data-lines="L21,L26,L27">
                        <h3>The Time Loop</h3>
                        <p>The main simulation loop. <code>runTime.run()</code> checks if the simulation has reached its end time. We increment the time step and print the current state to the console.</p>
                    </div>
        
                    <div class="cn-step" data-lines="L30,L31,L32,L36,L37,L38">
                        <h3>PIMPLE Solver</h3>
                        <p>Inside every time step, we run the PIMPLE loop (merged PISO-SIMPLE algorithm). This iteratively solves the Momentum (<code>UEqns</code>), Energy (<code>EEqns</code>), and Pressure (<code>pEqn</code>) equations until convergence is reached.</p>
                    </div>
        
                     <div class="cn-step" data-lines="L41,L44">
                        <h3>Acoustics & Output</h3>
                        <p>When a write interval is hit, we calculate the gas phase <strong>Mach Number</strong> on the fly using the computed velocity, pressure, and density fields, then write the results to disk.</p>
                    </div>
        
                    <div class="cn-spacer"></div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer>
        <p class="mb-4 text-gray-500 max-w-6xl mx-auto">
            Distributed under the GNU General Public License v3 (GPL-3.0). See the 
            <a href="https://github.com/Ganeshkumar-V/Propellant-Regression-Framework/main/LICENSE" 
               target="_blank" rel="noopener noreferrer" 
               class="text-gray-500 hover:text-gray-500 hover:underline">
               LICENSE
            </a> 
            file for the full text. This software is an independent project and is neither endorsed by, nor 
            associated with OpenCFD Ltd or the OpenFOAM® project. OpenFOAM® is a 
            registered trademark of OpenCFD Ltd.
        </p>

        <p>
            © 2025 Ganeshkumar V. All rights reserved.
        </p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        /* Initialize mermaid with responsive layout option */
        mermaid.initialize({ startOnLoad: true, flowchart: { useMaxWidth: true } });

        /*
         After mermaid renders the diagram(s) it inserts an <svg> with width/height attributes.
         To ensure the diagram scales when the page is zoomed, convert width/height to a viewBox
         and make the SVG responsive. We run once on DOMContentLoaded and also watch for changes
         because mermaid may render asynchronously.
        */
        document.addEventListener('DOMContentLoaded', function () {
            function makeSvgResponsive() {
                document.querySelectorAll('.mermaid svg').forEach(svg => {
                    try {
                        // If there's already a viewBox, assume it's responsive enough
                        if (!svg.getAttribute('viewBox')) {
                            const width = svg.getAttribute('width');
                            const height = svg.getAttribute('height');
                            if (width && height) {
                                svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
                                svg.removeAttribute('width');
                                svg.removeAttribute('height');
                                svg.style.width = '100%';
                                svg.style.height = 'auto';
                            }
                        }
                    } catch (e) {
                        // ignore any invalid SVGs
                    }
                });
            }

            // Initial attempt (mermaid may have already rendered)
            makeSvgResponsive();

            // Retry shortly after in case mermaid renders after DOMContentLoaded
            setTimeout(makeSvgResponsive, 500);

            // Observe DOM changes to the mermaid container and adjust newly added SVGs
            const mermaidContainers = document.querySelectorAll('.mermaid');
            mermaidContainers.forEach(container => {
                const observer = new MutationObserver(() => makeSvgResponsive());
                observer.observe(container, { childList: true, subtree: true });
            });
        });
    </script>
    
    <!-- svg-pan-zoom: enable interactive pan/zoom for rendered SVG diagrams
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
    <script>
        // Initialize svg-pan-zoom on every mermaid SVG once it's available
        function initPanZoomForMermaid(svg) {
            try {
                // If svg-pan-zoom instance already attached, return
                if (svg._svgPanZoom) return;

                // create an instance with reasonable defaults
                const instance = svgPanZoom(svg, {
                    zoomEnabled: true,
                    controlIconsEnabled: false,
                    fit: true,
                    center: true,
                    minZoom: 0.25,
                    maxZoom: 10,
                    dblClickZoomEnabled: true,
                    mouseWheelZoomEnabled: true
                });

                // store reference so we don't re-init
                svg._svgPanZoom = instance;

                // Adjust initial zoom so the diagram fills the container width
                function adjustInitialZoom() {
                    try {
                        instance.resize();

                        // Prefer computing scale from SVG viewBox to fill parent width
                        let vb = null;
                        try { vb = svg.viewBox && svg.viewBox.baseVal ? svg.viewBox.baseVal : null; } catch(e) { vb = null; }

                        const container = svg.parentElement || svg;
                        const containerWidth = container.clientWidth || container.getBoundingClientRect().width || 0;

                        if (vb && vb.width && containerWidth > 0) {
                            // target scale to fill width
                            const rawScale = containerWidth / vb.width;
                            const min = 0.25, max = 10;
                            const target = Math.min(max, Math.max(min, rawScale));

                            // apply target zoom and center
                            try { instance.zoom(target); } catch (e) { /* ignore */ }
                            try { instance.center(); } catch (e) { /* ignore */ }
                        } else {
                            // fallback to fit/center
                            try { instance.fit(); instance.center(); } catch (e) { /* ignore */ }
                        }
                    } catch (e) {
                        // retry once after a short delay
                        setTimeout(() => {
                            try { adjustInitialZoom(); } catch (e) {}
                        }, 120);
                    }
                }

                // run adjustment now
                adjustInitialZoom();
            } catch (e) {
                // fail silently
                console.warn('svg-pan-zoom init failed', e);
            }
        }

        // Watch for mermaid SVGs (handles async render)
        function watchMermaidSvgs() {
            document.querySelectorAll('.mermaid svg').forEach(svg => {
                // ensure viewBox exists (makes svg responsive)
                if (!svg.getAttribute('viewBox')) {
                    const w = svg.getAttribute('width');
                    const h = svg.getAttribute('height');
                    if (w && h) {
                        svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
                        svg.removeAttribute('width');
                        svg.removeAttribute('height');
                    }
                }
                initPanZoomForMermaid(svg);
            });

            // Observe for newly injected SVGs
            document.querySelectorAll('.mermaid').forEach(container => {
                if (container._mermaidObserver) return;
                const mo = new MutationObserver(() => {
                    // delay slightly to let mermaid finish writing SVG
                    setTimeout(() => watchMermaidSvgs(), 50);
                });
                mo.observe(container, { childList: true, subtree: true });
                container._mermaidObserver = mo;
            });
        }

        // Run after DOM is ready and after mermaid initializations
        document.addEventListener('DOMContentLoaded', () => {
            // small delay for mermaid to render
            setTimeout(() => watchMermaidSvgs(), 250);
            // retry once later
            setTimeout(() => watchMermaidSvgs(), 1000);
        });
    </script> -->

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" integrity="sha384-hIoIeC+BIfme/j+Lg+Ie8HhU3SvuxfwB3kI/S6UlP8Vq+M/fG5/SPOdsLWWiMcvx" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" integrity="sha384-43gA9SRQAFBuPWCiR/mkIhP+E8SjO7Iib/o9dZISTQ/kQceYPLQxfM/E1fixKJi/" crossorigin="anonymous"></script>

    <script>
        renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ]
        });
    </script>
    
    <script>
        const menuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        menuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });
    </script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        
        const steps = document.querySelectorAll('.cn-step');
        const lines = document.querySelectorAll('.cn-line');
        const codeWindow = document.querySelector('.cn-code-window');
    
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    // 1. Highlight the text card
                    steps.forEach(s => s.classList.remove('active'));
                    entry.target.classList.add('active');
    
                    // 2. Get lines from data attribute
                    const activeLineIds = entry.target.getAttribute('data-lines').split(',');
    
                    // 3. Reset all code lines
                    lines.forEach(l => l.classList.remove('active'));
    
                    // 4. Highlight specific lines AND Auto-Scroll
                    let firstActiveLine = null;
    
                    activeLineIds.forEach((id, index) => {
                        const el = document.getElementById(id);
                        if(el) {
                            el.classList.add('active');
                            if (index === 0) firstActiveLine = el;
                        }
                    });
    
                    // 5. The Auto-Scroll Logic
                    if (firstActiveLine && codeWindow) {
                        // Calculate position to scroll to (center the line)
                        const windowHeight = codeWindow.offsetHeight;
                        const lineTop = firstActiveLine.offsetTop;
                        const lineHeight = firstActiveLine.offsetHeight;
                        
                        // Scroll position = Line Position - Half Window Height + Half Line Height
                        const scrollTarget = lineTop - (windowHeight / 2) + (lineHeight / 2);
    
                        codeWindow.scrollTo({
                            top: scrollTarget,
                            behavior: 'smooth'
                        });
                    }
                }
            });
        }, {
            root: null,
            threshold: 0.6, // Wait until 60% of text is visible
            rootMargin: "-10% 0px -20% 0px" // Focus area in center-screen
        });
    
        steps.forEach(step => observer.observe(step));
    });
    </script>

</body>
</html>
